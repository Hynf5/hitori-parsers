name: Discord Â· Commit Notification

on:
  push:
    branches:
      - '**'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Get short commit hash
        id: commit
        run: echo "short=${GITHUB_SHA::10}" >> $GITHUB_OUTPUT

      - name: Build commit list
        id: commits
        run: |
          # Hitung jumlah commit
          COUNT=$(jq '.commits | length' $GITHUB_EVENT_PATH)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          # Buat list commit dengan format - [SHA](link) message - author
          LIST=$(jq -r '.commits[] | "- [\(.id[0:7])](\(.url)) \(.message) - \(.author.username)"' $GITHUB_EVENT_PATH)
          echo "list=$LIST" >> $GITHUB_OUTPUT

      # ===============================
      # 1ï¸âƒ£ EMBED INFO COMMIT (HEAD)
      # ===============================
      - name: Send Commit Info (Embed)
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}

          embed-title: "ğŸ§© New Commit: ${{ github.event.repository.name }}"
          embed-url: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          embed-thumbnail-url: "${{ secrets.PARSERS_THUMBNAIL_URL }}"
          embed-description: |
            > ğŸ“ **Repo:** `${{ github.repository }}`
            > ğŸŒ¿ **Branch:** `${{ github.ref_name }}`
            > ğŸ”– **Commit:** [`${{ steps.commit.outputs.short }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          embed-color: 15105570

      # ===============================
      # 2ï¸âƒ£ EMBED MESSAGE COMMIT 
      # ===============================
      - name: Send Commit Message (Embed)
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}

          embed-title: "ğŸ“ Message: ${{ steps.commits.outputs.count }} new Commit(s)"
          embed-description: |
            ${{ steps.commits.outputs.list }}
          embed-color: 15105570
          embed-footer-icon-url: "https://github.com/${{ github.actor }}.png"
          embed-footer-text: "${{ github.actor }}"
          embed-timestamp: "${{ github.event.head_commit.timestamp }}"
