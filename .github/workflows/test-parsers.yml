name: Parsers Check

on:
  push:
    branches:
      - hitori-pr
    paths:
      - 'src/main/kotlin/org/koitharu/kotatsu/parsers/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository üåè
        uses: actions/checkout@v5

      - name: Set up Java üîß
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle üì¶
        uses: gradle/actions/setup-gradle@v4

      # ===============================
      # üî• Compile parsers & save log
      # ===============================
      - name: Compile parsers üöÄ
        id: build
        run: |
          set -o pipefail
          ./gradlew compileKotlin --stacktrace 2>&1 | tee build.log

      - name: Set short SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA:0:10}" >> $GITHUB_ENV

      # ===============================
      # ‚ùå Capture Gradle Kotlin errors
      # ===============================
      - name: Capture Gradle Kotlin Errors
        id: gradle_errors
        if: failure()
        run: |
          # Extract file:line:error message from log (Kotlin compiler errors)
          ERRORS=$(grep -E "^[^:]+\.kt:[0-9]+: " build.log || true)
          # Batasi max 1500 karakter agar muat di Discord embed
          ERRORS=$(echo "$ERRORS" | head -c 1500)
          if [ -z "$ERRORS" ]; then
            ERRORS="No specific Kotlin compiler errors found, see full log."
          fi
          echo "ERROR_LOG<<EOF" >> $GITHUB_OUTPUT
          echo "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ===============================
      # ‚úÖ SUCCESS NOTIFICATION
      # ===============================
      - name: Notify Discord (Success) ‚úÖ
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "‚úÖ Test Parsers Build Success"
          embed-thumbnail-url: "${{ secrets.SUCCESS_THUMBNAIL_URL }}"
          embed-description: |
            > **üìÅ Repo:** `${{ github.repository }}`
            > **üåø Branch:** `${{ github.ref_name }}`
            > **üîñ Commit:** [`${{ env.SHORT_SHA }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          embed-color: 3066993
          embed-url: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

      # ===============================
      # 2Ô∏è‚É£ EMBED MESSAGE COMMIT
      # ===============================
      - name: Send Commit Message (Embed)
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "üìù Commit"
          embed-description: |
            > ${{ github.event.head_commit.message }}
          embed-color: 3066993
          embed-footer-icon-url: "https://github.com/${{ github.actor }}.png"
          embed-footer-text: "${{ github.actor }} | ${{ env.SHORT_SHA }}"

      # ===============================
      # ‚ùå ERROR NOTIFICATION
      # ===============================
      - name: Notify Discord (Failure) ‚õî
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "‚ùå Test Parsers Build Failed"
          embed-thumbnail-url: "${{ secrets.EROR_THUMBNAIL_URL }}"
          embed-description: |
            üö® **Error Summary**
            ‚Ä¢ Job: `build-and-test`
            ‚Ä¢ Step: `Compile parsers`
            
            **üìù Commit:**
            > ${{ github.event.head_commit.message }}

            **‚ö° Kotlin Compiler Errors:**
            ```
            ${{ steps.gradle_errors.outputs.ERROR_LOG }}
            ```
            
            **üîó Full Logs:**
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          embed-color: 15158332
          embed-footer-text: ${{ github.actor }} | ${{ env.SHORT_SHA }}
          embed-footer-icon-url: https://github.com/${{ github.actor }}.png
